name: Process Organization Batch

on:
  workflow_dispatch:
    inputs:
      batch_content:
        required: true
        type: string
        description: 'Base64-encoded JSON batch data'

jobs:
  load_json:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.load.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Decode batch content
        run: |
          echo "${{ github.event.inputs.batch_content }}" | base64 -d > batch.json
          echo "Decoded batch.json:"
          cat batch.json

      - id: load
        run: |
          echo "Loading Base64 batch content into matrix"
          MATRIX=$(jq -c . batch.json)
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT

  run_matrix:
    needs: load_json
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        org: ${{ fromJson(needs.load_json.outputs.matrix) }}

    steps:
      - name: Crawl and push using pipeline-action
        uses: culturecreates/artsdata-pipeline-action@v3
        with:
          mode: 'fetch-push'
          artifact: '${{ matrix.org.artifact }}'
          page-url: '${{ matrix.org.url }}'
          token: "${{ secrets.GITHUB_TOKEN }}"
          custom-databus-url: "http://staging.api.artsdata.ca/databus/"
          publisher: "http://kg.artsdata.ca/resource/K1-202"
